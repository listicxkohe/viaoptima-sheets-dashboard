<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 13px;
        margin: 0;
        padding: 0;
        background: #f5f7fb;
        color: #111827;
      }
      .header {
        padding: 12px 16px;
        background: #0f172a;
        color: #f8fafc;
        font-weight: 700;
        font-size: 14px;
        letter-spacing: 0.01em;
      }
      .tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
      }
      .tab {
        flex: 1;
        text-align: center;
        padding: 10px 0;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        border-bottom: 2px solid transparent;
        color: #6b7280;
      }
      .tab.active {
        border-bottom-color: #2563eb;
        color: #111827;
        background: #ffffff;
      }
      .content {
        padding: 14px 16px 18px;
      }
      .card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 14px;
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06);
        margin-bottom: 12px;
      }
      .section-title {
        font-weight: 700;
        margin: 0 0 6px;
        font-size: 13px;
        color: #111827;
      }
      .hint {
        font-size: 11px;
        color: #6b7280;
        margin: 0 0 10px;
        line-height: 1.4;
      }
      textarea {
        width: 100%;
        box-sizing: border-box;
        min-height: 140px;
        font-family: monospace;
        font-size: 11px;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        resize: vertical;
      }
      .btn-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }
      .btn {
        border: none;
        border-radius: 999px;
        padding: 9px 14px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        color: #ffffff;
        transition: all 120ms ease;
      }
      .btn-primary {
        background: #2563eb;
      }
      .btn-primary:hover {
        background: #1d4ed8;
      }
      .btn-secondary {
        background: #4b5563;
      }
      .btn-secondary:hover {
        background: #374151;
      }
      .btn-ghost {
        background: #e5e7eb;
        color: #111827;
      }
      .btn-ghost:hover {
        background: #d1d5db;
      }
      .btn-link {
        background: transparent;
        color: #2563eb;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr auto 50px;
        gap: 8px;
        margin: 6px 0;
        align-items: center;
      }
      .row label {
        font-size: 11px;
        color: #4b5563;
      }
      .row input[type="number"],
      .row input[type="range"] {
        width: 100%;
      }
      .weightLabel {
        text-align: right;
        font-size: 11px;
        color: #111827;
      }
      .status {
        margin-top: 8px;
        font-size: 11px;
        color: #6b7280;
      }
      .status.ok {
        color: #16a34a;
      }
      .status.error {
        color: #dc2626;
      }
      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 10px;
        background: #e5f2ff;
        color: #2563eb;
        margin-left: 4px;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
      }
      .input-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      .input-group label {
        font-size: 11px;
        color: #374151;
        font-weight: 600;
      }
      .input-group input {
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        font-size: 12px;
      }
      .subtle {
        font-size: 11px;
        color: #6b7280;
      }
      .footer-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
    </style>
  </head>
  <body>
    <div class="header">ViaOptima Control Panel</div>

    <div class="tabs">
      <div class="tab active" id="tab-dashboard" onclick="switchTab('dashboard')">
        Dashboard
      </div>
      <div class="tab" id="tab-settings" onclick="switchTab('settings')">
        Settings
      </div>
    </div>

    <div class="content">
      <!-- DASHBOARD TAB -->
      <div id="content-dashboard" class="tab-content active">
        <div class="card">
          <div class="section-title">Import data</div>
          <div class="hint">
            Paste weekly scorecard or daily route table into the field below, then choose which import to run.
          </div>
          <textarea id="rawInput"></textarea>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="runImport('weekly')">
              Import weekly scorecard
            </button>
            <button class="btn btn-secondary" onclick="runImport('daily')">
              Import daily routes
            </button>
          </div>
          <div id="importStatus" class="status"></div>
        </div>

        <div class="card">
          <div class="section-title">Leaderboard quick access</div>
          <div class="hint">Open the leaderboard dialog from here once imports are done.</div>
          <button class="btn btn-ghost" style="width: 100%;" onclick="openLeaderboard(true)">
            Open leaderboard
          </button>
          <div id="leaderboardStatus" class="status"></div>
        </div>
      </div>

      <!-- SETTINGS TAB -->
      <div id="content-settings" class="tab-content">
        <div class="card">
          <div class="section-title">
            Ranking weights <span class="pill">Config</span>
          </div>
          <div class="hint">
            DCR/POD/CC/DNR weights are normalised inside the quality score. Other sliders are multipliers in the final formula.
          </div>

          <div class="row">
            <label>DCR weight</label>
            <input type="range" id="wDcr" step="0.05" min="0" max="1" value="0.4" oninput="updateWeightLabel('Dcr')" />
            <span id="wDcrLabel" class="weightLabel">0.40</span>
          </div>
          <div class="row">
            <label>DNR DPMO weight</label>
            <input type="range" id="wDnr" step="0.05" min="0" max="1" value="0.15" oninput="updateWeightLabel('Dnr')" />
            <span id="wDnrLabel" class="weightLabel">0.15</span>
          </div>
          <div class="row">
            <label>POD weight</label>
            <input type="range" id="wPod" step="0.05" min="0" max="1" value="0.4" oninput="updateWeightLabel('Pod')" />
            <span id="wPodLabel" class="weightLabel">0.40</span>
          </div>
          <div class="row">
            <label>CC weight</label>
            <input type="range" id="wCc" step="0.05" min="0" max="1" value="0.2" oninput="updateWeightLabel('Cc')" />
            <span id="wCcLabel" class="weightLabel">0.20</span>
          </div>

          <hr style="margin: 8px 0; border: none; border-top: 1px solid #e5e7eb" />

          <div class="row">
            <label>Deliveries weight (volume)</label>
            <input type="range" id="wDeliveries" step="0.1" min="0" max="2" value="0.5" oninput="updateWeightLabel('Deliveries')" />
            <span id="wDeliveriesLabel" class="weightLabel">0.50</span>
          </div>
          <div class="row">
            <label>Weeks weight (experience)</label>
            <input type="range" id="wWeeks" step="0.1" min="0" max="2" value="0.3" oninput="updateWeightLabel('Weeks')" />
            <span id="wWeeksLabel" class="weightLabel">0.30</span>
          </div>

          <hr style="margin: 8px 0; border: none; border-top: 1px solid #e5e7eb" />

          <div class="row">
            <label>Rescues given weight (bonus)</label>
            <input type="range" id="wResGiven" step="0.1" min="0" max="3" value="1.0" oninput="updateWeightLabel('ResGiven')" />
            <span id="wResGivenLabel" class="weightLabel">1.00</span>
          </div>
          <div class="row">
            <label>Rescues taken weight (penalty)</label>
            <input type="range" id="wResTaken" step="0.1" min="0" max="3" value="1.0" oninput="updateWeightLabel('ResTaken')" />
            <span id="wResTakenLabel" class="weightLabel">1.00</span>
          </div>

          <hr style="margin: 8px 0; border: none; border-top: 1px solid #e5e7eb" />

          <div class="row">
            <label>Minimum weeks to rank</label>
            <input type="number" id="minWeeks" step="1" min="1" max="52" value="1" />
            <span></span>
          </div>

          <div class="btn-row">
            <button class="btn btn-primary" onclick="saveConfig()">Save leaderboard config</button>
          </div>
          <div id="configStatus" class="status"></div>
        </div>

        <div class="card">
          <div class="section-title">Sheet connections</div>
          <div class="hint">
            Point each logical sheet to another spreadsheet (optional). Leave blank to use the current file and default sheet names.
            Paste a spreadsheet URL or ID, plus the tab name.
          </div>
          <div class="grid-2" id="sheetConfigGrid">
            <!-- populated by JS -->
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="saveSheetConfig()">Save sheet config</button>
            <button class="btn btn-ghost" onclick="reloadSidebar()">Reload panel</button>
          </div>
          <div id="sheetStatus" class="status"></div>
        </div>

        <div class="card">
          <div class="section-title">Export attachments</div>
          <div class="hint">
            Optional: provide a Drive folder URL/ID. All PDFs in that folder will be appended after the scorecard PDF when exporting/emailing.
          </div>
          <div class="input-group">
            <label>Drive folder (PDF attachments)</label>
            <input id="attachFolderId" type="text" placeholder="Drive folder URL or ID" />
            <span class="subtle">Leave blank to disable extra attachments.</span>
          </div>
          <div class="btn-row">
            <button class="btn btn-primary" onclick="saveExportAttachments()">Save attachment folder</button>
          </div>
          <div id="attachStatus" class="status"></div>
        </div>
      </div>
    </div>

    <script>
      var SHEET_FIELDS = [
        { key: "scoreSheet", label: "Weekly scoreboard" },
        { key: "pasteSheet", label: "Raw paste buffer" },
        { key: "importedSheet", label: "Imported weeks list" },
        { key: "masterSheet", label: "Masterlist" },
        { key: "currentSheet", label: "Current-running list" },
        { key: "completeSheet", label: "Complete route list" },
      ];

      /*********** TABS ***********/
      function switchTab(which) {
        document.getElementById("tab-dashboard").classList.toggle("active", which === "dashboard");
        document.getElementById("tab-settings").classList.toggle("active", which === "settings");

        document.getElementById("content-dashboard").classList.toggle("active", which === "dashboard");
        document.getElementById("content-settings").classList.toggle("active", which === "settings");
      }

      /*********** IMPORT FUNCTIONS ***********/
      function runImport(type) {
        var text = document.getElementById("rawInput").value || "";
        var statusEl = document.getElementById("importStatus");
        if (!text.trim()) {
          statusEl.textContent = "Paste some data first.";
          statusEl.className = "status error";
          return;
        }

        statusEl.textContent = "Running " + type + " importâ€¦";
        statusEl.className = "status";

        var success = function (msg) {
          statusEl.textContent = msg;
          statusEl.className = "status ok";
          document.getElementById("rawInput").value = "";
        };
        var failure = function (err) {
          statusEl.textContent = "Error: " + err.message;
          statusEl.className = "status error";
        };

        if (type === "weekly") {
          google.script.run.withSuccessHandler(function () {
            success("Weekly import finished.");
          }).withFailureHandler(failure).importFromPaste(text);
        } else if (type === "daily") {
          google.script.run.withSuccessHandler(function () {
            success("Daily routes import finished.");
          }).withFailureHandler(failure).importDailyFromRaw(text);
        }
      }

      /*********** CONFIG LOAD / SAVE ***********/
      function updateWeightLabel(which) {
        var id = "w" + which;
        var el = document.getElementById(id);
        if (!el) return;
        var val = parseFloat(el.value) || 0;
        var label = document.getElementById(id + "Label");
        if (label) label.textContent = val.toFixed(2);
