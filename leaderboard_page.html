<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
      body {
        margin: 0;
        padding: 0;
        background: #f5f7fb;
        color: #1f2933;
      }
      .shell {
        padding: 20px 24px 24px;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 20px;
        font-weight: 600;
      }
      .subtitle {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 16px;
      }

      .summary-row {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      .summary-card {
        flex: 1 1 180px;
        background: #ffffff;
        border-radius: 10px;
        padding: 12px 14px;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        min-width: 180px;
      }
      .summary-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #6b7280;
        margin-bottom: 4px;
      }
      .summary-value {
        font-size: 20px;
        font-weight: 600;
      }
      .summary-note {
        font-size: 11px;
        color: #9ca3af;
      }

      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
        gap: 8px;
        flex-wrap: wrap;
      }

      .toolbar-left {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      .search-box input {
        border-radius: 999px;
        border: 1px solid #d1d5db;
        padding: 6px 10px;
        font-size: 12px;
        min-width: 220px;
      }

      .btn {
        border: none;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
      }
      .btn-primary {
        background: #2563eb;
        color: white;
      }
      .btn-ghost {
        background: #e5e7eb;
        color: #111827;
      }

      .table-wrapper {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        overflow: hidden;
        border: 1px solid #e5e7eb;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }
      thead {
        background: #f9fafb;
      }
      th, td {
        padding: 8px 10px;
        text-align: left;
        border-bottom: 1px solid #f1f5f9;
      }
      th {
        font-size: 11px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        cursor: pointer;
        user-select: none;
      }
      th.sortable span {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      th.sortable span::after {
        content: "↕";
        font-size: 10px;
        color: #9ca3af;
      }
      th.sortable.asc span::after {
        content: "↑";
      }
      th.sortable.desc span::after {
        content: "↓";
      }

      tbody tr:nth-child(even) {
        background: #f9fafb;
      }

      .badge-status {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 10px;
        font-weight: 500;
      }
      .badge-active {
        background: #dcfce7;
        color: #166534;
      }
      .badge-inactive {
        background: #fee2e2;
        color: #b91c1c;
      }
      .rank-pill {
        width: 24px;
        height: 24px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
      }
      .rank-gold {
        background: #fef3c7;
        color: #92400e;
      }
      .rank-silver {
        background: #e5e7eb;
        color: #4b5563;
      }
      .rank-bronze {
        background: #ffedd5;
        color: #92400e;
      }
      .rank-normal {
        background: #eef2ff;
        color: #3730a3;
      }

      .score-pill {
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 11px;
        font-weight: 500;
        background: #eff6ff;
        color: #1d4ed8;
      }

      .btn-scorecard {
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 11px;
        border: 1px solid #d1d5db;
        background: #f9fafb;
        cursor: not-allowed;
        color: #9ca3af;
      }

      .muted {
        color: #9ca3af;
        font-size: 11px;
      }

      .status-text {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <h1>Driver leaderboard</h1>
      <div class="subtitle">
        Ranking is based on weighted DCR, POD, CC, weeks and deliveries.
        Weights are controlled in the ViaOptima sidebar in your sheet.
      </div>

      <div class="summary-row">
        <div class="summary-card">
          <div class="summary-label">Total drivers</div>
          <div class="summary-value" id="sumTotalDrivers">–</div>
          <div class="summary-note">Active + inactive in masterlist</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Active drivers</div>
          <div class="summary-value" id="sumActiveDrivers">–</div>
          <div class="summary-note">Status = Active</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Total deliveries</div>
          <div class="summary-value" id="sumDeliveries">–</div>
          <div class="summary-note">All rows in Weekly-scoreboard</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Avg DCR</div>
          <div class="summary-value" id="sumDcr">–</div>
          <div class="summary-note">Across all weekly rows</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Avg POD</div>
          <div class="summary-value" id="sumPod">–</div>
          <div class="summary-note">Across all weekly rows</div>
        </div>
      </div>

      <div class="toolbar">
        <div class="toolbar-left">
          <div class="search-box">
            <input id="searchInput" type="text" placeholder="Search by driver or transporter ID…">
          </div>
        </div>
        <div class="toolbar-right">
          <button class="btn btn-ghost" id="btnRefresh">⟳ Refresh</button>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th class="sortable" data-field="rank"><span>Rank</span></th>
              <th>Driver</th>
              <th>Transporter ID</th>
              <th>Status</th>
              <th class="sortable" data-field="weeks"><span>Weeks</span></th>
              <th class="sortable" data-field="deliveries"><span>Deliveries</span></th>
              <th class="sortable" data-field="dcr"><span>DCR</span></th>
              <th class="sortable" data-field="pod"><span>POD</span></th>
              <th class="sortable" data-field="cc"><span>CC</span></th>
              <th class="sortable" data-field="score"><span>Score</span></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="11" class="muted" style="padding:14px;">Loading leaderboard…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="status-text" id="statusText"></div>
    </div>

    <script>
      let allRows = [];
      let filteredRows = [];
      let currentSortField = 'rank';
      let currentSortDir = 'asc'; // or 'desc'

      function setStatus(msg) {
        document.getElementById('statusText').textContent = msg || '';
      }

      function formatPercent(val) {
        if (val === null || val === undefined || val === '') return 'NA';
        return val.toFixed(1) + '%';
      }

      function formatNumber(n) {
        if (n === null || n === undefined) return '0';
        return n.toLocaleString();
      }

      function fetchLeaderboard() {
        setStatus('Loading from sheet…');
        document.getElementById('tbody').innerHTML =
          '<tr><td colspan="11" class="muted" style="padding:14px;">Loading leaderboard…</td></tr>';

        google.script.run
          .withSuccessHandler(function(data) {
            allRows = data.rows || [];
            filteredRows = allRows.slice();

            // Summary
            const s = data.summary || {};
            document.getElementById('sumTotalDrivers').textContent = s.totalDrivers ?? '0';
            document.getElementById('sumActiveDrivers').textContent = s.activeDrivers ?? '0';
            document.getElementById('sumDeliveries').textContent =
              s.totalDeliveries != null ? formatNumber(s.totalDeliveries) : '0';
            document.getElementById('sumDcr').textContent =
              s.avgDcr != null ? formatPercent(s.avgDcr) : 'NA';
            document.getElementById('sumPod').textContent =
              s.avgPod != null ? formatPercent(s.avgPod) : 'NA';

            applySearch();
            setStatus('Loaded.');
          })
          .withFailureHandler(function(err) {
            document.getElementById('tbody').innerHTML =
              '<tr><td colspan="11" class="muted" style="padding:14px;">Error loading: '
              + (err && err.message ? err.message : err) + '</td></tr>';
            setStatus('Error loading leaderboard – check Apps Script logs.');
          })
          .getLeaderboardData();
      }

      function applySearch() {
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if (!q) {
          filteredRows = allRows.slice();
        } else {
          filteredRows = allRows.filter(r =>
            (r.name || '').toLowerCase().includes(q) ||
            (r.transporterId || '').toLowerCase().includes(q)
          );
        }
        applySort();
      }

      function applySort(field, toggleDir = false) {
        if (field) {
          if (toggleDir && field === currentSortField) {
            currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
          } else {
            currentSortField = field;
            currentSortDir = 'desc';
          }
        }
        const dir = currentSortDir === 'asc' ? 1 : -1;
        const fld = currentSortField;

        filteredRows.sort((a, b) => {
          const va = a[fld];
          const vb = b[fld];

          // Nulls last
          if (va == null && vb == null) return 0;
          if (va == null) return 1;
          if (vb == null) return -1;

          if (typeof va === 'string') {
            return va.localeCompare(vb) * dir;
          }
          return (va - vb) * dir;
        });

        updateSortIcons();
        renderTable();
      }

      function updateSortIcons() {
        const ths = document.querySelectorAll('th.sortable');
        ths.forEach(th => {
          th.classList.remove('asc', 'desc');
          const field = th.getAttribute('data-field');
          if (field === currentSortField) {
            th.classList.add(currentSortDir);
          }
        });
      }

      function renderTable() {
        const tb = document.getElementById('tbody');
        if (!filteredRows.length) {
          tb.innerHTML = '<tr><td colspan="11" class="muted" style="padding:14px;">No drivers match this filter.</td></tr>';
          return;
        }

        const rowsHtml = filteredRows.map(row => {
          const rank = row.rank;
          let rankClass = 'rank-normal';
          let rankLabel = rank != null ? String(rank) : '–';
          if (rank === 1) { rankClass = 'rank-gold'; rankLabel = '1'; }
          else if (rank === 2) { rankClass = 'rank-silver'; rankLabel = '2'; }
          else if (rank === 3) { rankClass = 'rank-bronze'; rankLabel = '3'; }

          let statusBadge = '<span class="badge-status">' + (row.status || 'NA') + '</span>';
          if (/^active$/i.test(row.status)) {
            statusBadge = '<span class="badge-status badge-active">Active</span>';
          } else if (/inactive/i.test(row.status)) {
            statusBadge = '<span class="badge-status badge-inactive">Inactive</span>';
          }

          const dcr = row.dcr != null ? formatPercent(row.dcr) : 'NA';
          const pod = row.pod != null ? formatPercent(row.pod) : 'NA';
          const cc  = row.cc  != null ? formatPercent(row.cc)  : 'NA';
          const score = row.score != null ? row.score.toFixed(1) : 'NA';

          return `
            <tr>
              <td>
                ${rank != null
                  ? `<div class="rank-pill ${rankClass}">${rankLabel}</div>`
                  : ''}
              </td>
              <td>${row.name || ''}</td>
              <td>${row.transporterId || '<span class="muted">N/A</span>'}</td>
              <td>${statusBadge}</td>
              <td>${row.weeks != null ? row.weeks : '0'}</td>
              <td>${formatNumber(row.deliveries)}</td>
              <td>${dcr}</td>
              <td>${pod}</td>
              <td>${cc}</td>
              <td>${score !== 'NA' ? `<span class="score-pill">${score}</span>` : '<span class="muted">N/A</span>'}</td>
              <td><button class="btn-scorecard" title="Coming soon">Scorecard</button></td>
            </tr>`;
        }).join('');

        tb.innerHTML = rowsHtml;
      }

      // Wire up events
      document.addEventListener('DOMContentLoaded', function () {
        fetchLeaderboard();

        document.getElementById('btnRefresh').addEventListener('click', function () {
          fetchLeaderboard();
        });

        document.getElementById('searchInput').addEventListener('input', function () {
          applySearch();
        });

        document.querySelectorAll('th.sortable').forEach(th => {
          th.addEventListener('click', function () {
            const field = th.getAttribute('data-field');
            applySort(field, true);
          });
        });
      });
    </script>
  </body>
</html>
