<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
      body {
        margin: 0;
        padding: 0;
        background: #f5f7fb;
        color: #1f2933;
      }
      .shell {
        padding: 20px 24px 24px;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 20px;
        font-weight: 600;
      }
      .subtitle {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 16px;
      }

      .summary-row {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }
      .summary-card {
        flex: 1 1 180px;
        background: #ffffff;
        border-radius: 10px;
        padding: 12px 14px;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        min-width: 180px;
      }
      .summary-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #6b7280;
        margin-bottom: 4px;
      }
      .summary-value {
        font-size: 20px;
        font-weight: 600;
      }
      .summary-note {
        font-size: 11px;
        color: #9ca3af;
      }

      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
        gap: 8px;
        flex-wrap: wrap;
      }

      .toolbar-left {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      .search-box input {
        border-radius: 999px;
        border: 1px solid #d1d5db;
        padding: 6px 10px;
        font-size: 12px;
        min-width: 220px;
      }
      .week-filter select {
        border-radius: 999px;
        border: 1px solid #d1d5db;
        padding: 6px 10px;
        font-size: 12px;
        background: #ffffff;
        min-width: 180px;
      }

      .btn {
        border: none;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
      }
      .btn-primary {
        background: #2563eb;
        color: white;
      }
      .btn-ghost {
        background: #e5e7eb;
        color: #111827;
      }

      .table-wrapper {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        overflow: hidden;
        border: 1px solid #e5e7eb;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }
      thead {
        background: #f9fafb;
      }
      th, td {
        padding: 8px 10px;
        text-align: left;
        border-bottom: 1px solid #f1f5f9;
      }
      th {
        font-size: 11px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        cursor: pointer;
        user-select: none;
      }
      th.sortable span {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      th.sortable span::after {
        content: "⇅";
        font-size: 10px;
        color: #9ca3af;
      }
      th.sortable.asc span::after {
        content: "▲";
      }
      th.sortable.desc span::after {
        content: "▼";
      }

      tbody tr:nth-child(even) {
        background: #f9fafb;
      }

      .badge-status {
        display: inline-flex;
        align-items: center;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 10px;
        font-weight: 500;
      }
      .badge-active {
        background: #dcfce7;
        color: #166534;
      }
      .badge-inactive {
        background: #fee2e2;
        color: #b91c1c;
      }
      .rank-pill {
        width: 24px;
        height: 24px;
        border-radius: 999px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
      }
      .rank-gold {
        background: #fef3c7;
        color: #92400e;
      }
      .rank-silver {
        background: #e5e7eb;
        color: #4b5563;
      }
      .rank-bronze {
        background: #ffedd5;
        color: #92400e;
      }
      .rank-normal {
        background: #eef2ff;
        color: #3730a3;
      }

      .rank-delta {
        font-size: 10px;
        font-weight: 600;
        margin-left: 6px;
      }
      .rank-delta.up { color: #16a34a; }
      .rank-delta.down { color: #dc2626; }
      .rank-delta.flat { color: #9ca3af; }

      .score-pill {
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 11px;
        font-weight: 500;
        background: #eff6ff;
        color: #1d4ed8;
      }

      .btn-scorecard {
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 11px;
        border: 1px solid #bfdbfe;
        background: #eff6ff;
        color: #1d4ed8;
        cursor: pointer;
        transition: background 0.15s ease, transform 0.15s ease;
      }
      .btn-scorecard:hover:not([disabled]) {
        background: #dbeafe;
        transform: translateY(-1px);
      }
      .btn-scorecard[disabled] {
        cursor: not-allowed;
        background: #f3f4f6;
        border-color: #e5e7eb;
        color: #9ca3af;
        transform: none;
      }

      .muted {
        color: #9ca3af;
        font-size: 11px;
      }

      .status-text {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <h1>Driver leaderboard</h1>
      <div class="subtitle">
        Ranking is based on weighted DCR, POD, CC, weeks and deliveries.
        Weights are controlled in the ViaOptima sidebar in your sheet.
      </div>

      <div class="view-tabs" style="display:flex; gap:8px; margin-bottom:10px;">
        <button class="btn btn-ghost" id="tabList">List</button>
        <button class="btn btn-ghost" id="tabChart">Distribution</button>
      </div>

      <div class="summary-row">
        <div class="summary-card">
          <div class="summary-label">Total drivers</div>
          <div class="summary-value" id="sumTotalDrivers">-</div>
          <div class="summary-note">Active + inactive in masterlist</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Active drivers</div>
          <div class="summary-value" id="sumActiveDrivers">-</div>
          <div class="summary-note">Status = Active</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Total deliveries</div>
          <div class="summary-value" id="sumDeliveries">-</div>
          <div class="summary-note">All rows in Weekly-scoreboard</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Avg DCR</div>
          <div class="summary-value" id="sumDcr">-</div>
          <div class="summary-note">Across all weekly rows</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">Avg POD</div>
          <div class="summary-value" id="sumPod">-</div>
          <div class="summary-note">Across all weekly rows</div>
        </div>
      </div>

      <div class="toolbar">
        <div class="toolbar-left">
          <div class="week-filter">
            <select id="weekSelect">
              <option value="">Overall (all weeks)</option>
            </select>
          </div>
          <div class="search-box">
            <input id="searchInput" type="text" placeholder="Search by driver or transporter ID...">
          </div>
        </div>
        <div class="toolbar-right">
          <button class="btn btn-ghost" id="btnRefresh">Refresh</button>
        </div>
    </div>

      <div id="listView" class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th class="sortable" data-field="rank" title="Sort by current rank. Rank change compares to prior week when a week is selected."><span>Rank</span></th>
              <th title="Driver name from masterlist or scorecard data.">Driver</th>
              <th title="Transporter ID from weekly scoreboard.">Transporter ID</th>
              <th title="Active / inactive from masterlist.">Status</th>
              <th class="sortable" data-field="weeks" title="Number of weeks included for this view."><span>Weeks</span></th>
              <th class="sortable" data-field="deliveries" title="Total deliveries in the selected week (or filtered view)."><span>Deliveries</span></th>
              <th class="sortable" data-field="dcr" title="Delivery completion rate."><span>DCR</span></th>
              <th class="sortable" data-field="pod" title="Proof of delivery rate."><span>POD</span></th>
              <th class="sortable" data-field="cc" title="Customer contact rate."><span>CC</span></th>
              <th class="sortable" data-field="score" title="Overall weighted score using configured weights."><span>Score</span></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="11" class="muted" style="padding:14px;">Loading leaderboard...</td></tr>
          </tbody>
        </table>
      </div>

      <div id="chartView" class="panel chart-panel" style="display:none; margin-top:12px; background:#fff; border-radius:12px; padding:14px; box-shadow: 0 1px 3px rgba(15,23,42,0.08); border:1px solid #e5e7eb;">
        <div class="chart-header" style="display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;">
          <div>
            <div class="panel-title" style="font-size:14px; font-weight:600;">Score distribution</div>
            <div class="panel-subtitle" style="font-size:12px; color:#6b7280;">Histogram with smoothed curve; markers show mean/median/top.</div>
          </div>
        </div>
        <div class="chart-container" style="height:280px; position:relative; margin-top:10px;">
          <canvas id="distChart"></canvas>
          <div id="distEmpty" class="chart-empty" style="position:absolute; inset:0; display:none; align-items:center; justify-content:center; color:#9ca3af; font-size:12px;">No score data to chart for this view.</div>
        </div>
        <div style="font-size:11px; color:#6b7280; margin-top:6px;">
          X-axis: score (higher = better). Y-axis: drivers (count). Bars show the team distribution; the green line is a smoothed bell curve.
        </div>
        <div class="distribution-stats" style="display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; font-size:12px;">
          <div><strong>Mean:</strong> <span id="statMean">-</span></div>
          <div><strong>Median:</strong> <span id="statMedian">-</span></div>
          <div><strong>Std dev:</strong> <span id="statStd">-</span></div>
          <div><strong>P25:</strong> <span id="statP25">-</span></div>
          <div><strong>P75:</strong> <span id="statP75">-</span></div>
          <div><strong>Top:</strong> <span id="statMax">-</span></div>
          <div><strong>N:</strong> <span id="statCount">-</span></div>
        </div>
        <div id="bucketDetails" style="margin-top:12px; font-size:12px; color:#1f2933;"></div>
      </div>

      <div class="status-text" id="statusText"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
      let allRows = [];
      let filteredRows = [];
      let currentSortField = 'rank';
      let currentSortDir = 'asc'; // or 'desc'
      let weekOptions = [];
      let selectedWeek = null;
      let viewMode = 'list';
      let distChart = null;
      let distribution = null;

      function setStatus(msg) {
        document.getElementById('statusText').textContent = msg || '';
      }

      function formatPercent(val) {
        if (val === null || val === undefined || val === '') return 'NA';
        return val.toFixed(1) + '%';
      }

      function formatNumber(n) {
        if (n === null || n === undefined) return '0';
        return n.toLocaleString();
      }

      function fetchLeaderboard(requestedWeek) {
        if (typeof requestedWeek !== 'undefined') {
          selectedWeek = requestedWeek;
        }
        setStatus('Loading ' + getWeekLabel(selectedWeek) + '...');
        document.getElementById('tbody').innerHTML =
          '<tr><td colspan="11" class="muted" style="padding:14px;">Loading leaderboard...</td></tr>';

        google.script.run
          .withSuccessHandler(function(data) {
            allRows = data.rows || [];
            filteredRows = allRows.slice();
            weekOptions = data.weekOptions || [];
            selectedWeek = data.appliedWeek != null ? data.appliedWeek : null;
            buildWeekSelect();
            distribution = data.distribution || null;

            // Summary
            const s = data.summary || {};
            document.getElementById('sumTotalDrivers').textContent = s.totalDrivers ?? '0';
            document.getElementById('sumActiveDrivers').textContent = s.activeDrivers ?? '0';
            document.getElementById('sumDeliveries').textContent =
              s.totalDeliveries != null ? formatNumber(s.totalDeliveries) : '0';
            document.getElementById('sumDcr').textContent =
              s.avgDcr != null ? formatPercent(s.avgDcr) : 'NA';
            document.getElementById('sumPod').textContent =
              s.avgPod != null ? formatPercent(s.avgPod) : 'NA';

            applySearch();
            setStatus('Loaded ' + getWeekLabel(selectedWeek) + '.');
            renderDistribution();
          })
          .withFailureHandler(function(err) {
            document.getElementById('tbody').innerHTML =
              '<tr><td colspan="11" class="muted" style="padding:14px;">Error loading: '
              + (err && err.message ? err.message : err) + '</td></tr>';
            setStatus('Error loading leaderboard – check Apps Script logs.');
          })
          .getLeaderboardData(selectedWeek);
      }

      function buildWeekSelect() {
        var select = document.getElementById('weekSelect');
        if (!select) return;
        var opts = (weekOptions && weekOptions.length)
          ? weekOptions
          : [{ value: null, label: 'Overall (all weeks)' }];
        select.innerHTML = opts.map(function(opt) {
          var val = opt.value == null ? '' : String(opt.value);
          var label = opt.label || (opt.value == null ? 'Overall (all weeks)' : 'Week ' + opt.value);
          return '<option value=\"' + val + '\">' + label + '</option>';
        }).join('');
        select.value = selectedWeek == null ? '' : String(selectedWeek);
      }

      function getWeekLabel(value) {
        if (value == null) return 'overall';
        for (var i = 0; i < (weekOptions || []).length; i++) {
          var opt = weekOptions[i];
          if (String(opt.value) === String(value)) {
            return opt.label || ('Week ' + value);
          }
        }
        return 'week ' + value;
      }

      function applySearch() {
        const q = document.getElementById('searchInput').value.trim().toLowerCase();
        if (!q) {
          filteredRows = allRows.slice();
        } else {
          filteredRows = allRows.filter(r =>
            (r.name || '').toLowerCase().includes(q) ||
            (r.transporterId || '').toLowerCase().includes(q)
          );
        }
        applySort();
      }

      function applySort(field, toggleDir = false) {
        if (field) {
          if (toggleDir && field === currentSortField) {
            currentSortDir = currentSortDir === 'asc' ? 'desc' : 'asc';
          } else {
            currentSortField = field;
            currentSortDir = 'desc';
          }
        }
        const dir = currentSortDir === 'asc' ? 1 : -1;
        const fld = currentSortField;

        filteredRows.sort((a, b) => {
          const va = a[fld];
          const vb = b[fld];

          // Nulls last
          if (va == null && vb == null) return 0;
          if (va == null) return 1;
          if (vb == null) return -1;

          if (typeof va === 'string') {
            return va.localeCompare(vb) * dir;
          }
          return (va - vb) * dir;
        });

        updateSortIcons();
        renderTable();
      }

      function updateSortIcons() {
        const ths = document.querySelectorAll('th.sortable');
        ths.forEach(th => {
          th.classList.remove('asc', 'desc');
          const field = th.getAttribute('data-field');
          if (field === currentSortField) {
            th.classList.add(currentSortDir);
          }
        });
      }

      function openScorecard(transporterId, driverName, buttonEl) {
        if (!transporterId) return;
        var btn = buttonEl || null;
        if (btn) {
          btn.disabled = true;
          btn.dataset.originalLabel = btn.dataset.originalLabel || btn.textContent;
          btn.textContent = "Opening...";
        }
        setStatus("Opening scorecard for " + (driverName || transporterId) + "...");
        google.script.run
          .withSuccessHandler(function () {
            setStatus("Scorecard opened for " + (driverName || transporterId) + ".");
            if (btn) {
              btn.disabled = false;
              btn.textContent = btn.dataset.originalLabel || "Scorecard";
            }
          })
          .withFailureHandler(function (err) {
            var message = err && err.message ? err.message : "Unknown error";
            setStatus("Failed to open scorecard: " + message);
            if (btn) {
              btn.disabled = false;
              btn.textContent = btn.dataset.originalLabel || "Scorecard";
            }
            alert("Could not open scorecard:\n" + message);
          })
          .openDriverScorecardDialog(transporterId, driverName || "", selectedWeek);
      }

      function renderTable() {
        const tb = document.getElementById('tbody');
        if (!filteredRows.length) {
          tb.innerHTML = '<tr><td colspan="11" class="muted" style="padding:14px;">No drivers match this filter.</td></tr>';
          return;
        }

        const rowsHtml = filteredRows.map(row => {
          const rank = row.rank;
          let rankClass = 'rank-normal';
          let rankLabel = rank != null ? String(rank) : '-';
          if (rank === 1) { rankClass = 'rank-gold'; rankLabel = '1'; }
          else if (rank === 2) { rankClass = 'rank-silver'; rankLabel = '2'; }
          else if (rank === 3) { rankClass = 'rank-bronze'; rankLabel = '3'; }
          const delta = formatRankDelta(row.rankChange);

          let statusBadge = '<span class="badge-status">' + (row.status || 'NA') + '</span>';
          if (/^active$/i.test(row.status)) {
            statusBadge = '<span class="badge-status badge-active">Active</span>';
          } else if (/inactive/i.test(row.status)) {
            statusBadge = '<span class="badge-status badge-inactive">Inactive</span>';
          }

          const dcr = row.dcr != null ? formatPercent(row.dcr) : 'NA';
          const pod = row.pod != null ? formatPercent(row.pod) : 'NA';
          const cc  = row.cc  != null ? formatPercent(row.cc)  : 'NA';
          const score = row.score != null ? row.score.toFixed(1) : 'NA';
          const encodedName = encodeURIComponent(row.name || '');
          const buttonCell = row.transporterId
            ? `<button class="btn-scorecard" data-id="${row.transporterId}" data-name="${encodedName}">Scorecard</button>`
            : '<span class="muted">ID missing</span>';

          return `
            <tr>
              <td>
                ${rank != null
                  ? `<div class="rank-pill ${rankClass}">${rankLabel}</div>`
                  : ''}
                ${delta}
              </td>
              <td>${row.name || ''}</td>
              <td>${row.transporterId || '<span class="muted">N/A</span>'}</td>
              <td>${statusBadge}</td>
              <td>${row.weeks != null ? row.weeks : '0'}</td>
              <td>${formatNumber(row.deliveries)}</td>
              <td>${dcr}</td>
              <td>${pod}</td>
              <td>${cc}</td>
              <td>${score !== 'NA' ? `<span class="score-pill">${score}</span>` : '<span class="muted">N/A</span>'}</td>
              <td>${buttonCell}</td>
            </tr>`;
        }).join('');

        tb.innerHTML = rowsHtml;
        var scoreButtons = tb.querySelectorAll('.btn-scorecard');
        for (var i = 0; i < scoreButtons.length; i++) {
          scoreButtons[i].addEventListener('click', function () {
            var driverName = decodeURIComponent(this.getAttribute('data-name') || '');
            openScorecard(this.getAttribute('data-id'), driverName, this);
          });
        }
      }

      function formatRankDelta(change) {
        if (change == null) return '';
        var cls = change > 0 ? 'up' : change < 0 ? 'down' : 'flat';
        var arrow = change > 0 ? '▲' : change < 0 ? '▼' : '→';
        return `<span class="rank-delta ${cls}" title="Change vs prior week">${arrow} ${Math.abs(change)}</span>`;
      }

      function renderDistribution() {
        var empty = document.getElementById('distEmpty');
        var canvas = document.getElementById('distChart');
        if (!canvas || !distribution) return;
        var buckets = (distribution.buckets || []).filter(function(b) { return b.count != null; });
        var smoothed = distribution.smoothed || [];
        var stats = distribution.stats || {};
        var bucketSize = distribution.bucketSize || 1;
        var bucketDrivers = distribution.bucketDrivers || [];

        if (!buckets.length) {
          if (distChart) distChart.destroy();
          distChart = null;
          empty.style.display = 'flex';
          canvas.style.display = 'none';
        } else {
          empty.style.display = 'none';
          canvas.style.display = 'block';
          var maxCount = buckets.reduce(function(m, b) { return Math.max(m, b.count || 0); }, 0);
          var curve = buildNormalCurve(buckets, stats, maxCount, bucketSize);
          var maxCurveY = curve.reduce(function(m, p) { return Math.max(m, p.y); }, 0);
          var yMax = Math.max(maxCount, maxCurveY) * 1.2;
          var xMin = distribution.minScore != null ? Math.floor(distribution.minScore - 2) : undefined;
          var xMax = distribution.maxScore != null ? Math.ceil(distribution.maxScore + 2) : undefined;
          if (distChart) distChart.destroy();
          distChart = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
              datasets: [
                {
                  type: 'bar',
                  label: 'Drivers',
                  data: buckets.map(function(b) {
                    return { x: (b.from + b.to) / 2, y: b.count };
                  }),
                  backgroundColor: 'rgba(99,102,241,0.4)',
                  borderColor: '#6366f1',
                  borderWidth: 1,
                  parsing: false,
                  barPercentage: 0.9,
                  categoryPercentage: 0.9,
                },
                {
                  type: 'line',
                  label: 'Bell curve (scaled)',
                  data: curve.map(function(p) { return { x: p.x, y: p.y }; }),
                  tension: 0.35,
                  borderColor: '#22c55e',
                  backgroundColor: 'rgba(34,197,94,0.15)',
                  pointRadius: 0,
                  yAxisID: 'y',
                  parsing: false,
                },
                buildMarkerLine('Mean', stats.mean, '#1d4ed8', yMax),
                buildMarkerLine('Median', stats.median, '#10b981', yMax),
                buildMarkerLine('P90', stats.p90, '#f59e0b', yMax),
                buildMarkerLine('P95', stats.p95, '#ef4444', yMax),
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  type: 'linear',
                  stacked: false,
                  ticks: { color: '#6b7280' },
                  title: { display: true, text: 'Score' },
                  min: xMin,
                  max: xMax,
                },
                y: { beginAtZero: true, suggestedMax: yMax, ticks: { color: '#6b7280' } },
              },
              plugins: { legend: { position: 'bottom' } },
            },
            plugins: [{
              id: 'bucket-click',
              afterEvent: function(chart, args) {
                var event = args.event;
                if (event.type !== 'click') return;
                var points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, false);
                if (!points || !points.length) return;
                var first = points[0];
                if (first.datasetIndex !== 0) return; // only bars
                var bucketIndex = first.index;
                renderBucketDetails(bucketIndex, bucketDrivers[bucketIndex], buckets[bucketIndex]);
              }
            }]
          });
        }

        document.getElementById('statMean').textContent = stats.mean != null ? stats.mean.toFixed(1) : '-';
        document.getElementById('statMedian').textContent = stats.median != null ? stats.median.toFixed(1) : '-';
        document.getElementById('statStd').textContent = stats.stddev != null ? stats.stddev.toFixed(1) : '-';
        document.getElementById('statP25').textContent = stats.p25 != null ? stats.p25.toFixed(1) : '-';
        document.getElementById('statP75').textContent = stats.p75 != null ? stats.p75.toFixed(1) : '-';
        document.getElementById('statMax').textContent = stats.max != null ? stats.max.toFixed(1) : '-';
        document.getElementById('statCount').textContent = stats.count != null ? stats.count : '0';
      }

      function renderBucketDetails(idx, drivers, bucket) {
        var container = document.getElementById('bucketDetails');
        if (!container) return;
        if (!drivers || !drivers.length || !bucket) {
          container.innerHTML = '';
          return;
        }
        var title = 'Drivers in score range ' + bucket.label + ' (' + drivers.length + '):';
        var list = drivers
          .sort(function(a, b) { return (b.score || 0) - (a.score || 0); })
          .map(function(d) {
            var name = d.name || 'Unknown';
            var id = d.transporterId || 'N/A';
            var sc = d.score != null ? d.score.toFixed(1) : '-';
            return '<li>' + name + ' (' + id + ') – ' + sc + '</li>';
          })
          .join('');
        container.innerHTML = '<div style="font-weight:600;">' + title + '</div><ul style="margin:6px 0 0 14px; padding:0;">' + list + '</ul>';
      }

      function buildNormalCurve(buckets, stats, maxCount, bucketSize) {
        if (!buckets.length || !stats || stats.stddev == null || stats.stddev === 0) return [];
        var minX = Math.min.apply(null, buckets.map(function(b) { return b.from; }));
        var maxX = Math.max.apply(null, buckets.map(function(b) { return b.to; }));
        var steps = 40;
        var points = [];
        var mean = stats.mean;
        var sd = stats.stddev || 1;
        // Gaussian density
        function gaussian(x) {
          var coeff = 1 / (sd * Math.sqrt(2 * Math.PI));
          var exponent = -((x - mean) * (x - mean)) / (2 * sd * sd);
          return coeff * Math.exp(exponent);
        }
        // Scale density to approximate counts
        var sampleMax = 0;
        for (var i = 0; i <= steps; i++) {
          var x = minX + (i / steps) * (maxX - minX);
          sampleMax = Math.max(sampleMax, gaussian(x));
        }
        var scale = sampleMax ? maxCount / sampleMax : 1;
        for (var j = 0; j <= steps; j++) {
          var xx = minX + (j / steps) * (maxX - minX);
          points.push({ x: xx, y: gaussian(xx) * scale });
        }
        return points;
      }

      function buildMarkerLine(label, value, color, yMax) {
        if (value == null || isNaN(value)) return { data: [] };
        return {
          type: 'line',
          label: label,
          data: [
            { x: value, y: 0 },
            { x: value, y: yMax || 0 }
          ],
          borderColor: color,
          borderWidth: 1,
          borderDash: [4, 4],
          pointRadius: 0,
          yAxisID: 'y',
          parsing: false,
        };
      }

      // Wire up events
      document.addEventListener('DOMContentLoaded', function () {
        fetchLeaderboard();

        document.getElementById('btnRefresh').addEventListener('click', function () {
          fetchLeaderboard();
        });

        const weekSelect = document.getElementById('weekSelect');
        if (weekSelect) {
          weekSelect.addEventListener('change', function () {
            const val = this.value;
            selectedWeek = val === '' ? null : parseInt(val, 10);
            fetchLeaderboard(selectedWeek);
          });
        }

        document.getElementById('searchInput').addEventListener('input', function () {
          applySearch();
        });

        document.querySelectorAll('th.sortable').forEach(th => {
          th.addEventListener('click', function () {
            const field = th.getAttribute('data-field');
            applySort(field, true);
          });
        });

        document.getElementById('tabList').addEventListener('click', function () {
          viewMode = 'list';
          document.getElementById('listView').style.display = 'block';
          document.getElementById('chartView').style.display = 'none';
          this.classList.add('btn-primary');
          document.getElementById('tabChart').classList.remove('btn-primary');
        });
        document.getElementById('tabChart').addEventListener('click', function () {
          viewMode = 'chart';
          document.getElementById('listView').style.display = 'none';
          document.getElementById('chartView').style.display = 'block';
          this.classList.add('btn-primary');
          document.getElementById('tabList').classList.remove('btn-primary');
          renderDistribution();
        });
        document.getElementById('tabList').classList.add('btn-primary');
      });
    </script>
  </body>
</html>
